#!/bin/bash
set -e

COMMAND="$1"
shift || true

# Defaults
IP=""
REMOTE_PATH=""
REMOTE_USER="pi"

# Parse args
while [[ "$#" -gt 0 ]]; do
    case $1 in
        --ip) IP="$2"; shift 2 ;;
        --path) REMOTE_PATH="$2"; shift 2 ;;
        --user) REMOTE_USER="$2"; shift 2 ;;  
        *) echo "Unknown option: $1"; exit 1 ;;
    esac
done

BUNDLE="build/linux/arm64/release/bundle"

function do_build() {
    echo "üèóÔ∏è  Building Flutter ARM64 (Docker)..."

    docker run --rm \
      --platform linux/arm64 \
      -v "$PWD":/app \
      -w /app \
      flutter-arm64 \
      /bin/bash -c "
        git config --global --add safe.directory /app && \
        echo 'üßπ Cleaning (Container)...' && \
        flutter clean && \
        echo 'üì¶ Fetching packages (Container)...' && \
        flutter pub get && \
        echo 'üî® Compiling...' && \
        flutter build linux --release
      "

    echo "üîß Fixing permissions..."
    sudo chown -R $(whoami):$(whoami) .

    echo "‚úÖ Build complete."
}

function do_deploy() {
    if [[ -z "$IP" || -z "$REMOTE_PATH" ]]; then
        echo "‚ùå Usage: flutter-pi deploy --ip <ip> --path <folder> [--user <user>]"
        exit 1
    fi

    echo "üöÄ Deploying to $REMOTE_USER@$IP..."
    ssh "$REMOTE_USER@$IP" "mkdir -p $REMOTE_PATH"
    rsync -avz --delete "$BUNDLE/" "$REMOTE_USER@$IP:$REMOTE_PATH/"
    echo "‚úÖ Deploy complete."
}

function do_run() {
    if [[ -z "$IP" || -z "$REMOTE_PATH" ]]; then
        echo "‚ùå Usage: flutter-pi run --ip <ip> --path <folder> [--user <user>]"
        exit 1
    fi

    echo "üñ•Ô∏è  Running app on Pi..."
    ssh "$REMOTE_USER@$IP" "cd $REMOTE_PATH && \
    EXEC=\$(find . -maxdepth 1 -type f -executable ! -name '*.so' | head -n 1) && \
    echo \"Starting \$EXEC...\" && \
    export DISPLAY=:0 && \
    nohup \$EXEC >/dev/null 2>&1 &"
}

function do_build_deploy() {
    do_build
    do_deploy
}

case $COMMAND in
    build) do_build ;;
    deploy) do_deploy ;;
    run) do_run ;;
    build-deploy) do_build_deploy ;;
    *)
        echo "Unknown command: $COMMAND"
        exit 1
        ;;
esac
