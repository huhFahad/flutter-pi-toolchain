#!/bin/bash
set -e

COMMAND="$1"
shift || true

# Defaults
SSH_TARGET=""
REMOTE_PATH=""

# Parse args
while [[ "$#" -gt 0 ]]; do
    case $1 in
        --target) SSH_TARGET="$2"; shift 2 ;;
        --path) REMOTE_PATH="$2"; shift 2 ;;
        *) echo "Unknown option: $1"; exit 1 ;;
    esac
done

# PATHS
RAW_BUNDLE="build/linux/arm64/release/bundle"
SAFE_BUNDLE="pi-release"

# SAFETY CHECK: Ensure we are in a Flutter project
if [ ! -f "pubspec.yaml" ]; then
    echo "‚ùå Error: No 'pubspec.yaml' found."
    echo "   You must run this command from the root of your Flutter project."
    exit 1
fi

function do_build() {
    echo "üèóÔ∏è  Building Flutter ARM64 (Docker)..."

    # 1. Build inside Docker
    docker run --rm \
      --platform linux/arm64 \
      -v "$PWD":/app \
      -w /app \
      flutter-arm64 \
      /bin/bash -c "
        git config --global --add safe.directory /app && \
        echo 'üßπ Cleaning (Container)...' && \
        flutter clean && \
        echo 'üì¶ Fetching packages (Container)...' && \
        flutter pub get && \
        echo 'üî® Compiling...' && \
        flutter build linux --release
      "

    # 2. Fix Permissions
    # We reclaim ownership of EVERYTHING in this folder.
    # This fixes linux/flutter/ephemeral, windows/flutter/ephemeral, etc.
    echo "üîß Fixing permissions..."
    sudo chown -R $(whoami):$(whoami) .

    # 3. Move Artifacts to Safe Harbor
    echo "üì¶ Backing up build to '$SAFE_BUNDLE/'..."
    rm -rf "$SAFE_BUNDLE"
    mkdir -p "$SAFE_BUNDLE"
    cp -r "$RAW_BUNDLE"/* "$SAFE_BUNDLE"/

    # 4. HOST CLEANUP
    echo "üßπ Resetting host environment for local debugging..."
    
    # Now that we own the files, we can delete them safely
    rm -rf build .dart_tool
    
    # Restore local dependencies
    flutter pub get > /dev/null

    echo "‚úÖ Build saved to '$SAFE_BUNDLE/'."
    echo "‚ú® Project is clean and ready!"
}

function do_deploy() {
    if [[ -z "$SSH_TARGET" || -z "$REMOTE_PATH" ]]; then
        echo "‚ùå Usage: flutter-pi deploy --target <user@ip> --path <folder>"
        exit 1
    fi

    if [ ! -d "$SAFE_BUNDLE" ]; then
        echo "‚ùå No Pi build found in '$SAFE_BUNDLE/'."
        echo "   Please run 'flutter-pi build' first."
        exit 1
    fi

    # SAFETY CHECK: Prevent deleting root
    if [[ "$REMOTE_PATH" == "/" || "$REMOTE_PATH" == "." ]]; then
        echo "‚ùå DANGER: Refusing to deploy to root ($REMOTE_PATH)."
        exit 1
    fi

    echo "üöÄ Deploying from '$SAFE_BUNDLE' to $SSH_TARGET..."
    
    ssh "$SSH_TARGET" "mkdir -p $REMOTE_PATH"
    rsync -avz --delete "$SAFE_BUNDLE/" "$SSH_TARGET:$REMOTE_PATH/"
    
    echo "‚úÖ Deploy complete."
}

function do_run() {
    if [[ -z "$SSH_TARGET" || -z "$REMOTE_PATH" ]]; then
        echo "‚ùå Usage: flutter-pi run --target <user@ip> --path <folder>"
        exit 1
    fi

    echo "üñ•Ô∏è  Running app on Pi..."
    
    # ELF Check + Process Kill + Nohup
    ssh "$SSH_TARGET" "cd $REMOTE_PATH && \
    EXEC=\$(find . -maxdepth 1 -type f -exec sh -c 'head -c 4 \"\$1\" | grep -q \"ELF\"' _ {} \; -print | head -n 1) && \
    if [ -z \"\$EXEC\" ]; then echo '‚ùå No executable found!'; exit 1; fi && \
    echo \"Found executable: \$EXEC\" && \
    echo \"Killing old instances...\" && \
    pkill -f \"\$EXEC\" || true && \
    echo \"Starting new instance...\" && \
    export DISPLAY=:0 && \
    nohup \"\$EXEC\" >/dev/null 2>&1 &"
}

function do_build_deploy() {
    do_build
    do_deploy
}

function do_deploy_run() {
    do_deploy
    do_run
}

function do_build_deploy_run() {
    do_build
    do_deploy
    do_run
}

case $COMMAND in
    build) do_build ;;
    deploy) do_deploy ;;
    run) do_run ;;
    build-deploy) do_build_deploy ;;
    deploy-run) do_deploy_run ;;
    build-deploy-run) do_build_deploy_run ;;
    *)
        echo "Unknown command: $COMMAND"
        exit 1
        ;;
esac
