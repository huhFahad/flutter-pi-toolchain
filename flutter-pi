#!/bin/bash
set -e

COMMAND="$1"
shift || true

# Defaults
IP=""
REMOTE_PATH=""
USER="pi"  # Default user

# Parse args
while [[ "$#" -gt 0 ]]; do
    case $1 in
        --ip) IP="$2"; shift 2 ;;
        --path) REMOTE_PATH="$2"; shift 2 ;;
        --user) USER="$2"; shift 2 ;; # Added user flag
        *) echo "Unknown option: $1"; exit 1 ;;
    esac
done

# Standard Flutter Linux Build Path
BUNDLE="build/linux/arm64/release/bundle"

function do_build() {
    echo "üèóÔ∏è  Building Flutter ARM64 (Docker)..."
    
    # CHANGE: Mounted to /app to match Dockerfile safe.directory
    # CHANGE: Added --platform to force QEMU usage
    docker run --rm \
      --platform linux/arm64 \
      -v "$PWD":/app \
      -w /app \
      flutter-arm64 \
      flutter build linux --release

    echo "‚úÖ Build complete."
}

function do_deploy() {
    if [[ -z "$IP" || -z "$REMOTE_PATH" ]]; then
        echo "‚ùå Usage: flutter-pi deploy --ip <ip> --path <folder> [--user <user>]"
        exit 1
    fi

    echo "üöÄ Deploying to $USER@$IP..."

    # Ensure remote folder exists
    ssh "$USER@$IP" "mkdir -p $REMOTE_PATH"
    
    # Sync files
    rsync -avz --delete "$BUNDLE/" "$USER@$IP:$REMOTE_PATH/"

    echo "‚úÖ Deploy complete."
}

function do_run() {
    if [[ -z "$IP" || -z "$REMOTE_PATH" ]]; then
        echo "‚ùå Usage: flutter-pi run --ip <ip> --path <folder> [--user <user>]"
        exit 1
    fi

    # CHANGE: Smarter executable detection (finds the one with no extension)
    # We run a remote command to find the executable file in the directory
    EXEC_CMD="find $REMOTE_PATH -maxdepth 1 -type f ! -name '*.*' -delete ; ls $REMOTE_PATH | head -n 1" 
    
    # Actually, simpler approach: The executable name usually matches the folder name or project name. 
    # Let's rely on finding the only executable file that isn't a .so
    
    echo "üñ•Ô∏è  Running app on Pi..."
    
    # SSH command to find executable and run it
    ssh "$USER@$IP" "cd $REMOTE_PATH && \
    EXEC=\$(find . -maxdepth 1 -type f -executable ! -name '*.so' | head -n 1) && \
    echo \"Starting \$EXEC...\" && \
    export DISPLAY=:0 && \
    nohup \$EXEC >/dev/null 2>&1 &"
}

function do_build_deploy() {
    do_build
    do_deploy
}

case $COMMAND in
    build) do_build ;;
    deploy) do_deploy ;;
    run) do_run ;;
    build-deploy) do_build_deploy ;;
    *)
        echo "Unknown command: $COMMAND"
        exit 1
        ;;
esac
